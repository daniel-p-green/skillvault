# Progress Log
Run: 300ed9e4-b9f5-4ec0-b1ad-b3a93d41de43
Task: SkillVault v0.1 (WEEKEND MVP) — SKILL.md trust layer (CLI-first; no installer/registry/marketplace).
Started: 2026-02-10 19:07 America/Chicago

## Codebase Patterns
- Keep JSON contract fields explicitly versioned (`contract_version`) and export stable constants (e.g., `CONTRACT_VERSION`, `ReasonCodes`) to prevent silent drift.
- For contract stability tests in Vitest, prefer explicit list equality (not snapshots) so additive-only changes are intentional.
- When testing a yargs CLI by calling `main()` multiple times in one process, reset `process.exitCode` at the start of `main()` to avoid exit-code leakage between tests.

- Deterministic goldens: centralize frozen timestamp in a single exported constant (e.g., `DETERMINISTIC_CREATED_AT_ISO`) and reuse it across scan/receipt/verify outputs.
- Bundle hashing: compute `bundle_sha256` from sorted `path + '\n' + file_sha256 + '\n'`, with bytewise UTF-8 path sorting for deterministic cross-input hashes (dir vs zip).
- Multi-input commands (bundle OR receipt): use a `receiptFromInput()` helper that tries to parse receipt JSON first, otherwise falls back to `generateReceipt()` on the bundle; keep ordering + keys deterministic.
- Golden regression tests: commit deterministic CLI JSON outputs under `packages/cli/test/goldens/**` and compare byte-for-byte in Vitest to catch nondeterministic drift.
- Contract evolution pattern: export per-command contract IDs (`skillvault.<command>.v1`) from `contracts.ts` and assert their literal values in tests.
- Canonical JSON for signing/goldens: recursively sort object keys (leave array order unchanged) and serialize without whitespace to produce byte-stable UTF-8 payloads.
- Shared trust helpers live in `src/manifest/*` and `src/text/*`; use them across scan/verify/gate/export to keep manifest findings and normalization/token behavior deterministic.
- Policy parsing pattern: keep one strict parser (`src/policy/policy.ts`) that merges validated YAML overlays onto a stable `DEFAULT_POLICY_V1`, so omitted `--policy` behavior is deterministic across commands.
- Capability inference pattern: keep a fixed rule-map module (`src/scan/capabilities.ts`) with path/content regexes over normalized text, then dedupe + lexicographically sort capabilities for stable receipts/gates.

---

## 2026-02-10 19:17 - US-001: Define v0.1 JSON contracts (types + docs) for scan/receipt/verify/diff
- Added canonical TypeScript contracts module for v0.1 JSON outputs (ScanReport/Receipt/VerifyReport/GateReport/DiffReport + supporting types).
- Documented the JSON shapes, verdict thresholds, and stable reason codes in `docs/schemas.md`.
- Added Vitest tests that lock down contract version, verdict thresholds, risk→verdict mapping, and the additive-only reason code list.
- Files changed:
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/index.ts`
  - `packages/cli/test/contracts.test.ts`
  - `docs/schemas.md`
- **Learnings:** codify reason codes as exported string arrays + tests to ensure downstream fixtures remain stable.
---

## 2026-02-10 20:21 - US-010: Implement `skillvault receipt` (offline-verifiable receipt JSON)
- Implemented `skillvault receipt <bundle_dir|bundle.zip> [--policy policy.yaml] [--out receipt.json] [--deterministic]`.
- Added minimal deterministic scan pipeline (bundle read + per-file sha256 + bundle_sha256 + SKILL.md manifest count check) as the single source of truth for receipt generation.
- Receipt now includes `scanner` (name + version), bundle hash + file hashes, scan summary, and policy decision.
- Updated schema docs to reflect the new `scanner` field.
- Files changed:
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/lib/{bundle,hash,policy,scan,receipt,time}.ts`
  - `packages/cli/test/fixtures/**`
  - `packages/cli/test/receipt.test.ts`
  - `docs/schemas.md`
- **Learnings:** prefer a dedicated `readBundle()` abstraction early so later commands (scan/verify/diff/export) share deterministic traversal and hashing.
---

## 2026-02-10 20:31 - US-001: Add policy.v1 contract + shared CLI options (no behavior change)
- Added `policy.v1` TypeScript contract types (gates, capability rules, constraints, profiles).
- Added `PolicyLoadError` + `parsePolicyV1()`/`loadPolicyV1()` loader stub with ReasonCode mapping for parse/schema failures.
- Made CLI accept shared flags globally across commands: `--policy`, `--format`, `--out`, `--deterministic`.
- Fixed testability bug where `process.exitCode` leaked between multiple `main()` calls.
- Files changed:
  - `packages/cli/src/policy-v1.ts`
  - `packages/cli/src/lib/policy-loader.ts`
  - `packages/cli/src/lib/policy.ts`
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/index.ts`
  - `packages/cli/test/{policy-v1,cli-options}.test.ts`
  - `packages/cli/test/contracts.test.ts`
- **Learnings:** for strict yargs CLIs, define shared options at the parser level so every command accepts them without per-command duplication.
---

## 2026-02-10 20:42 - US-011: Implement `skillvault verify` (hard-fail on hash mismatch and policy/constraints violations)
- Added `skillvault verify <bundle> --receipt receipt.json [--policy policy.yaml] [--offline] [--format json|table] [--deterministic]`.
- Verify recomputes per-file sha256 + bundle_sha256 and hard-fails on missing/extra files, file hash mismatch, and bundle hash mismatch with stable reason codes.
- Enforced policy.v1 constraints/capability rules deterministically (including v0.1 placeholder approvals via REQUIRED_APPROVAL_MISSING).
- Added tests covering pass case, tamper detection, required-approval failures, and table output; ensured tests clean up temp dirs.
- Files changed:
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/lib/verify.ts`
  - `packages/cli/test/{contracts,receipt,verify}.test.ts`
  - `packages/cli/test/fixtures/policy-require-approval.yaml`
  - `.gitignore`
- **Learnings:** clean up `mkdtemp()` artifacts in Vitest tests (and/or ignore `test-tmp-*`) to keep `git status` clean.
---

## 2026-02-11 20:52 - US-012: Implement `skillvault gate` (receipt-only or bundle input)
- Implemented `skillvault gate (--receipt receipt.json | <bundle>) --policy policy.yaml [--format json|table] [--deterministic]`.
- Added deterministic gating engine that can:
  - gate a bundle by scanning then applying `policy.v1` gates/constraints/capability rules
  - gate a receipt by applying the same rules to stored receipt scan + file metadata (without reading bundle contents)
- Gate output is a stable `GateReport` with exit code 0 on PASS/WARN and 1 on any error-level findings.
- Files changed:
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/lib/gate.ts`
  - `packages/cli/test/gate.test.ts`
- **Learnings:** for receipt-only gating, enforce only constraints derivable from receipt metadata (file sizes/paths/capabilities); avoid content-dependent checks unless the receipt stores the required bytes.
---

## 2026-02-10 20:56 - US-013: Implement `skillvault diff` for bundle/receipt pairs with deterministic security-relevant deltas
- Implemented `skillvault diff --a <bundle|receipt> --b <bundle|receipt> [--format json|table] [--deterministic]`.
- Added diff engine that accepts bundle or receipt JSON inputs; bundles are converted to receipts in-memory for canonical comparisons.
- Diff report includes deterministic:
  - `file_diffs` (added/removed/modified/unchanged by per-file sha256)
  - `capability_deltas` (added/removed)
  - `finding_deltas` (added/removed by `rule_id` when available)
- Updated schema docs for `DiffReport`.
- Files changed:
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/lib/diff.ts`
  - `packages/cli/test/diff.test.ts`
  - `docs/schemas.md`
- **Learnings:** for CLI commands that accept multiple input types, validate by minimal structural checks (receipt-like JSON) before falling back to bundle scanning.
---

## 2026-02-11 21:10 - US-014: Implement `skillvault export` to strict_v0 zip and validate constraints
- Implemented `skillvault export <bundle_dir> --out bundle.zip --profile strict_v0`.
- Export enforces strict_v0 hygiene: no symlinks, safe/relative paths only, exactly-one-manifest (SKILL.md/skill.md), deterministic entry ordering, and policy/profile size+token constraints.
- After writing the zip, re-opens it and re-validates paths + constraints before exiting 0.
- Added new reason codes for strict bundle hygiene.
- Files changed:
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/lib/export.ts`
  - `packages/cli/test/contracts.test.ts`
  - `packages/cli/test/export.test.ts`
- **Learnings:** On default macOS case-insensitive filesystems, you can't create both `SKILL.md` and `skill.md` in the same directory; tests for manifest-count violations should cover the missing-manifest case instead of relying on case-only filename differences.
---

## 2026-02-10 21:16 - US-015: Add fixtures, goldens, and deterministic golden-test harness for scan/receipt/verify/diff
- Added a second fixture bundle (`malicious-skill`) and committed deterministic JSON goldens for scan/receipt/verify/diff.
- Implemented a Vitest golden-test harness that runs the CLI with `--deterministic` and compares JSON outputs byte-for-byte against committed goldens.
- Added a tamper regression test asserting verify fails with stable reason codes when any file is modified.
- Wired up `skillvault scan` CLI (it previously existed in `lib/scan.ts` but the command was stubbed).
- Added a GitHub Actions CI workflow that runs build/typecheck/test (goldens included).
- Files changed:
  - `packages/cli/src/cli.ts`
  - `packages/cli/test/fixtures/malicious-skill/**`
  - `packages/cli/test/goldens/**`
  - `packages/cli/test/helpers/goldens.ts`
  - `packages/cli/test/goldens.test.ts`
  - `packages/cli/test/cli-options.test.ts`
  - `packages/cli/test/cli-options.test.ts`
  - `packages/cli/package.json`
  - `package.json`
  - `.github/workflows/ci.yml`
- **Learnings:** Keep deterministic goldens as literal CLI output strings (pretty JSON + trailing newline) so diffs are immediately actionable.
---

## 2026-02-11 21:24 - US-016: Add CI workflow to enforce typecheck, tests, and golden determinism
- Ensured golden tests are non-destructive by default, and only regenerate committed goldens when `REGEN_GOLDENS=1`.
- Added explicit Vitest coverage for the golden harness behavior (no-regenerate default + regen flag).
- Files changed:
  - `packages/cli/test/helpers/goldens.ts`
  - `packages/cli/test/golden-harness.test.ts`
- **Learnings:** Gate golden regeneration behind an explicit env var so CI can enforce byte-for-byte determinism.
---

## 2026-02-10 21:32 - US-017: Write command reference, policy reference, and scoring rubric docs
- Updated `README.md` with a v0.1 quickstart and all must-ship commands (with key flags).
- Added `docs/cli.md` with per-command synopsis, conventions, and examples for JSON/table output.
- Added `docs/policy.md` documenting the policy.v1 YAML schema, a minimal policy example, and profile usage.
- Updated `docs/scoring.md` and `docs/PRD.md` to match v0.1 `risk_score` components and PASS/WARN/FAIL thresholds.
- Files changed:
  - `README.md`
  - `docs/{cli,policy,scoring,PRD}.md`
  - `packages/cli/test/docs-smoke.test.ts`
- **Learnings:** For doc smoke tests, keep assertions string-based (command names + required files) rather than snapshots so future doc edits don’t cause noisy golden churn.
---
## 2026-02-15 14:40 - US-001: Define v0.1 JSON contracts: scan.v1 + receipt.v1 + verify/gate/diff/export
- Added explicit contract identifier exports in `contracts.ts` for each CLI output surface: `skillvault.scan.v1`, `skillvault.receipt.v1`, `skillvault.verify.v1`, `skillvault.gate.v1`, `skillvault.diff.v1`, `skillvault.export.v1`.
- Extended receipt contract with signed envelope schema: `signature: { alg: 'ed25519', key_id?, payload_sha256, sig }`.
- Added additive-only reason codes for signature/receipt schema failures: `RECEIPT_SCHEMA_INVALID`, `SIGNATURE_INVALID`, `SIGNATURE_KEY_NOT_FOUND`.
- Moved `ExportReport` contract shape into shared `contracts.ts` and updated export lib to consume it.
- Added contract tests validating new contract-id constants and updated stable ReasonCodes list.
- Files changed:
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/lib/export.ts`
  - `packages/cli/test/contracts.test.ts`
- **Learnings:** Keep per-command contract identifiers as exported constants in one module so tests and CLI outputs can version independently from a single numeric `contract_version` string.
---
## 2026-02-15 14:43 - US-002: Implement deterministic clock + canonical JSON serialization utilities
- Added `src/util/determinism.ts` with frozen deterministic timestamp constant and helper for runtime/deterministic `created_at` generation.
- Added `src/util/canonicalJson.ts` with canonical serializer + UTF-8 byte encoder for deterministic payload hashing/signing inputs.
- Updated `src/lib/time.ts` to delegate to the new determinism utility while preserving existing API usage across scan/receipt/verify/gate/diff/export.
- Added unit tests for canonical nested key ordering, byte-stable UTF-8 output, and deterministic/non-deterministic clock behavior.
- Files changed:
  - `packages/cli/src/util/determinism.ts`
  - `packages/cli/src/util/canonicalJson.ts`
  - `packages/cli/src/lib/time.ts`
  - `packages/cli/test/determinism.test.ts`
- **Learnings:** keep deterministic primitives (`created_at`, canonical JSON bytes) in dedicated utility modules so signing, goldens, and report generation reuse one implementation.
---
## 2026-02-15 14:53 - US-003: Bundle hashing: per-file sha256 + bundle_sha256 from sorted paths+hashes
- Added a dedicated hashing module at `src/bundle/hashing.ts` that:
  - hashes each bundle file over raw bytes into deterministic `FileEntry[]` (`path`, `size`, `sha256`)
  - sorts by bytewise UTF-8 path order
  - computes `bundle_sha256` from canonical `path + '\n' + file_sha256 + '\n'` concatenation.
- Updated scan flow to use the new hashing module directly.
- Kept `lib/hash.ts` as a compatibility wrapper for existing call sites while aligning bundle hash semantics.
- Added tests validating per-file hashing and equivalence between directory and zip inputs.
- Regenerated deterministic goldens to reflect updated bundle hash canonicalization.
- Files changed:
  - `packages/cli/src/bundle/hashing.ts`
  - `packages/cli/src/lib/hash.ts`
  - `packages/cli/src/lib/scan.ts`
  - `packages/cli/test/bundle-hashing.test.ts`
  - `packages/cli/test/goldens/**`
- **Learnings:** when hash contracts change, golden fixtures catch downstream drift immediately; keep canonicalization logic centralized and reused by scan/receipt/verify/diff paths.
---
## 2026-02-15 15:05 - US-004: Manifest detection + text normalization (UTF-8 NFC + newline normalization)
- Added `packages/cli/src/manifest/manifest.ts` for deterministic root-manifest detection (`SKILL.md`/`skill.md`) with stable `CONSTRAINT_MANIFEST_COUNT` findings when count != 1.
- Added `packages/cli/src/text/normalize.ts` for deterministic text normalization (UTF-8 NFC + `\n` newline normalization) and normalized token counting for analysis-only paths.
- Updated scan/verify/gate/export flows to reuse manifest detection and normalization helpers while preserving raw-byte hashing behavior.
- Added tests covering manifest count violations, root-manifest selection, normalization behavior, and proof that manifest SHA-256 comes from raw bytes (not normalized text).
- Files changed:
  - `packages/cli/src/manifest/manifest.ts`
  - `packages/cli/src/text/normalize.ts`
  - `packages/cli/src/lib/{scan,verify,gate,export}.ts`
  - `packages/cli/test/manifest-normalize.test.ts`
- **Learnings:** centralize manifest-count and normalization rules in shared helpers so scan/verify/gate/export stay consistent and reason-code output remains stable.
---
## 2026-02-15 15:14 - US-005: Policy.v1 YAML parsing + validation + defaults
- Implemented strict policy.v1 YAML parser/loader in `packages/cli/src/policy/policy.ts` with typed validation for gates, capability rules, constraints, and profile overlays.
- Added deterministic built-in `DEFAULT_POLICY_V1` and made `loadPolicyV1()` return it when `--policy` is omitted.
- Standardized parse and validation failures to throw `PolicyLoadError` with stable reason `POLICY_PARSE_ERROR` and structured `details`.
- Replaced legacy loader implementation with a compatibility re-export from the new policy module.
- Expanded policy tests to cover defaults, no-policy loading behavior, invalid YAML errors, and schema validation errors.
- Files changed:
  - `packages/cli/src/policy/policy.ts`
  - `packages/cli/src/lib/policy-loader.ts`
  - `packages/cli/test/policy-v1.test.ts`
- **Learnings:** Merge user policy as a validated overlay over a stable default object to keep CLI behavior deterministic when policy files are absent or partial.
---
## 2026-02-15 15:24 - US-006: Deterministic capability inference via rule map
- Implemented deterministic capability inference module in `packages/cli/src/scan/capabilities.ts` using a fixed path/content regex rule map for `network`, `exec`, `writes`, `reads`, `secrets`, and `dynamic_code`.
- Updated scan pipeline to infer capabilities from bundle files using normalized text (`UTF-8 NFC` + normalized newlines), while preserving raw bytes for hashing.
- Ensured inference output is deduped and sorted deterministically.
- Added focused unit tests for sorted/deduped inference, deterministic behavior across file-order permutations, and normalized text matching.
- Regenerated impacted deterministic goldens (`malicious-skill` scan/receipt + diff golden) to reflect new inferred capability output.
- Files changed:
  - `packages/cli/src/scan/capabilities.ts`
  - `packages/cli/src/lib/scan.ts`
  - `packages/cli/test/capabilities.test.ts`
  - `packages/cli/test/goldens/malicious-skill/scan.json`
  - `packages/cli/test/goldens/malicious-skill/receipt.json`
  - `packages/cli/test/goldens/diff/benign-vs-malicious.json`
- **Learnings:** treat capability inference as pure, rule-based analysis over normalized text with deterministic file ordering to keep scan/receipt/diff fixtures stable.
---
