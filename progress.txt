# Progress Log
Run: 300ed9e4-b9f5-4ec0-b1ad-b3a93d41de43
Task: SkillVault v0.1 (WEEKEND MVP) — SKILL.md trust layer (CLI-first; no installer/registry/marketplace).
Started: 2026-02-10 19:07 America/Chicago

## Codebase Patterns
- Keep JSON contract fields explicitly versioned (`contract_version`) and export stable constants (e.g., `CONTRACT_VERSION`, `ReasonCodes`) to prevent silent drift.
- For contract stability tests in Vitest, prefer explicit list equality (not snapshots) so additive-only changes are intentional.
- When testing a yargs CLI by calling `main()` multiple times in one process, reset `process.exitCode` at the start of `main()` to avoid exit-code leakage between tests.

- Deterministic goldens: centralize frozen timestamp in a single exported constant (e.g., `DETERMINISTIC_CREATED_AT_ISO`) and reuse it across scan/receipt/verify outputs.
- Bundle hashing: compute `bundle_sha256` from sorted `path + \0 + file_sha256 + \0` to stay platform-independent and avoid JSON-serialization drift.

---

## 2026-02-10 19:17 - US-001: Define v0.1 JSON contracts (types + docs) for scan/receipt/verify/diff
- Added canonical TypeScript contracts module for v0.1 JSON outputs (ScanReport/Receipt/VerifyReport/GateReport/DiffReport + supporting types).
- Documented the JSON shapes, verdict thresholds, and stable reason codes in `docs/schemas.md`.
- Added Vitest tests that lock down contract version, verdict thresholds, risk→verdict mapping, and the additive-only reason code list.
- Files changed:
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/index.ts`
  - `packages/cli/test/contracts.test.ts`
  - `docs/schemas.md`
- **Learnings:** codify reason codes as exported string arrays + tests to ensure downstream fixtures remain stable.
---

## 2026-02-10 20:21 - US-010: Implement `skillvault receipt` (offline-verifiable receipt JSON)
- Implemented `skillvault receipt <bundle_dir|bundle.zip> [--policy policy.yaml] [--out receipt.json] [--deterministic]`.
- Added minimal deterministic scan pipeline (bundle read + per-file sha256 + bundle_sha256 + SKILL.md manifest count check) as the single source of truth for receipt generation.
- Receipt now includes `scanner` (name + version), bundle hash + file hashes, scan summary, and policy decision.
- Updated schema docs to reflect the new `scanner` field.
- Files changed:
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/lib/{bundle,hash,policy,scan,receipt,time}.ts`
  - `packages/cli/test/fixtures/**`
  - `packages/cli/test/receipt.test.ts`
  - `docs/schemas.md`
- **Learnings:** prefer a dedicated `readBundle()` abstraction early so later commands (scan/verify/diff/export) share deterministic traversal and hashing.
---

## 2026-02-10 20:31 - US-001: Add policy.v1 contract + shared CLI options (no behavior change)
- Added `policy.v1` TypeScript contract types (gates, capability rules, constraints, profiles).
- Added `PolicyLoadError` + `parsePolicyV1()`/`loadPolicyV1()` loader stub with ReasonCode mapping for parse/schema failures.
- Made CLI accept shared flags globally across commands: `--policy`, `--format`, `--out`, `--deterministic`.
- Fixed testability bug where `process.exitCode` leaked between multiple `main()` calls.
- Files changed:
  - `packages/cli/src/policy-v1.ts`
  - `packages/cli/src/lib/policy-loader.ts`
  - `packages/cli/src/lib/policy.ts`
  - `packages/cli/src/contracts.ts`
  - `packages/cli/src/cli.ts`
  - `packages/cli/src/index.ts`
  - `packages/cli/test/{policy-v1,cli-options}.test.ts`
  - `packages/cli/test/contracts.test.ts`
- **Learnings:** for strict yargs CLIs, define shared options at the parser level so every command accepts them without per-command duplication.
---
